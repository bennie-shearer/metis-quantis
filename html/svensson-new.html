<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bond Yield Curve Fitting - Svensson (Filtered)</title>
    <style>
        /**
         * METIS Application Suite
         * Combined Stylesheet for Bond Yield Curve Fitting Application
         */

        /* ===== VARIABLES ===== */
        :root {
            /* Primary colors */
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --primary-dark: #1e6091;
            --primary-light: #a0cfee;
            --secondary-color: #93c5fd;

            /* Neutral colors */
            --background-color: #ffffff;
            --light-color: #f5f5f5;
            --light-gray: #f0f0f0;
            --mid-gray: #e0e0e0;
            --border-color: #e5e7eb;
            --text-color: #333333;
            --text-secondary: #666666;

            /* Status colors */
            --success-color: #22c55e;
            --success-light: #dcfce7;
            --warning-color: #f59e0b;
            --warning-light: #fef3c7;
            --danger-color: #ef4444;
            --danger-light: #fee2e2;
            --info-color: #3b82f6;
            --info-light: #dbeafe;

            /* Component colors */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --hover-bg: #e9f7fe;
            --button-bg: #f9fafb;
            --button-hover: #f3f4f6;
            --button-active: #e5e7eb;

            /* Dark mode colors */
            --dark-background: #111827;
            --dark-surface: #1f2937;
            --dark-border: #374151;
            --dark-text: #f3f4f6;

            /* Layout variables */
            --sidebar-width: 280px;
            --header-height: 60px;
            --footer-height: 40px;
            --toolbar-height: 50px;
            --statusbar-height: 24px;

            /* Spacing variables */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Border radius */
            --border-radius-sm: 2px;
            --border-radius-md: 4px;
            --border-radius-lg: 8px;

            /* Typography */
            --font-family-base: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-family-brand: 'Garamond', serif;

            --font-size-xs: 0.75rem;   /* 12px */
            --font-size-sm: 0.875rem;  /* 14px */
            --font-size-md: 1rem;      /* 16px */
            --font-size-lg: 1.125rem;  /* 18px */
            --font-size-xl: 1.25rem;   /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */

            /* Transition speeds */
            --transition-fast: 0.1s;
            --transition-normal: 0.2s;
            --transition-slow: 0.3s;

            /* Z-index layers */
            --z-index-dropdown: 100;
            --z-index-sticky: 200;
            --z-index-fixed: 300;
            --z-index-modal: 400;
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family-base);
        }

        html, body {
            height: 100%;
            width: 100%;
            font-size: 16px;
            line-height: 1.5;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: var(--spacing-md);
        }

        p {
            margin-bottom: var(--spacing-md);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-normal);
        }

        a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Selection styles */
        ::selection {
            background-color: var(--primary-light);
            color: var(--text-color);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--mid-gray);
            border-radius: var(--border-radius-md);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #c0c0c0;
        }

        /* ===== LAYOUT ===== */
        /* Main Container Layout */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background-color: var(--light-color);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: var(--spacing-md);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        /* Content Area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            background-color: var(--light-color);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .content-body {
            flex: 1;
            overflow: auto;
            padding: var(--spacing-md);
        }

        /* Grid System */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -var(--spacing-sm);
        }

        .col {
            flex: 1 0 0%;
            padding: 0 var(--spacing-sm);
        }

        .col-auto {
            flex: 0 0 auto;
            width: auto;
            padding: 0 var(--spacing-sm);
        }

        .col-1 { flex: 0 0 auto; width: 8.33333%; }
        .col-2 { flex: 0 0 auto; width: 16.66667%; }
        .col-3 { flex: 0 0 auto; width: 25%; }
        .col-4 { flex: 0 0 auto; width: 33.33333%; }
        .col-5 { flex: 0 0 auto; width: 41.66667%; }
        .col-6 { flex: 0 0 auto; width: 50%; }
        .col-7 { flex: 0 0 auto; width: 58.33333%; }
        .col-8 { flex: 0 0 auto; width: 66.66667%; }
        .col-9 { flex: 0 0 auto; width: 75%; }
        .col-10 { flex: 0 0 auto; width: 83.33333%; }
        .col-11 { flex: 0 0 auto; width: 91.66667%; }
        .col-12 { flex: 0 0 auto; width: 100%; }

        /* ===== COMPONENTS ===== */
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .btn:hover {
            background-color: var(--button-hover);
        }

        .btn:active {
            background-color: var(--button-active);
            transform: translateY(1px);
        }

        .btn i, .btn .icon {
            margin-right: var(--spacing-xs);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-hover);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--light-color);
            border-color: var(--border-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-size-xs);
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: var(--font-size-md);
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-sm);
            transition: border-color var(--transition-normal);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .form-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .form-col {
            flex: 1;
        }

        /* Cards */
        .card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin-bottom: var(--spacing-md);
        }

        .card-header {
            background-color: var(--light-color);
            padding: var(--spacing-md);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        .card-body {
            padding: var(--spacing-md);
        }

        .card-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            background-color: var(--light-color);
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: var(--spacing-sm);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background-color: var(--light-color);
            font-weight: 600;
        }

        .table tr:hover td {
            background-color: var(--hover-bg);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--light-color);
        }

        .tab {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-normal);
        }

        .tab:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }

        .tab-content {
            display: none;
            padding: var(--spacing-md);
        }

        .tab-content.active {
            display: block;
        }

        /* Yield Curve App Specific Styles */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .file-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
        }

        .method-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .method-link {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: var(--border-radius-md);
            text-decoration: none;
            transition: background-color var(--transition-normal);
        }

        .method-link:hover {
            background-color: var(--hover-bg);
            text-decoration: none;
        }

        .method-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-hover);
        }

        .tab-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: var(--light-color);
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
            margin-right: 5px;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .loader {
            border: 6px solid var(--light-color);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--danger-color);
            padding: 10px;
            background-color: var(--danger-light);
            border-radius: var(--border-radius-md);
            margin-top: 10px;
            display: none;
        }

        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .method-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
        }

        .method-card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        .method-card-body {
            padding: 15px;
        }

        .method-card-footer {
            padding: 15px;
            background-color: var(--light-color);
            text-align: center;
        }

        .method-desc {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        /* Helper Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-5 { margin-bottom: var(--spacing-xl); }

        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mt-5 { margin-top: var(--spacing-xl); }

        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        /* Responsive Breakpoints */
        @media (max-width: 640px) {
            .sidebar {
                width: 100%;
                min-width: 100%;
                position: fixed;
                z-index: var(--z-index-fixed);
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .col-sm-12 { width: 100%; }

            .method-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .col-md-6 { width: 50%; }
            .col-md-12 { width: 100%; }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body.auto-dark-mode {
                --background-color: var(--dark-background);
                --text-color: var(--dark-text);
                --light-color: var(--dark-surface);
                --border-color: var(--dark-border);
                --button-bg: #2d3748;
                --button-hover: #374151;
                --button-active: #4b5563;
            }
        }

        body.dark-mode {
            --background-color: var(--dark-background);
            --text-color: var(--dark-text);
            --light-color: var(--dark-surface);
            --border-color: var(--dark-border);
            --button-bg: #2d3748;
            --button-hover: #374151;
            --button-active: #4b5563;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Bond Yield Curve Fitting</h1>

    <div class="method-nav">
        <a href="index.html" class="method-link">Overview</a>
        <a href="nelson-siegel.html" class="method-link">Nelson-Siegel</a>
        <a href="exp-splines.html" class="method-link">Exponential Splines</a>
        <a href="b-splines.html" class="method-link">B-Splines</a>
        <a href="svensson.html" class="method-link">Svensson</a>
        <a href="svensson-new.html" class="method-link active">Svensson (Filtered)</a>
    </div>

    <div class="controls">
        <input type="file" class="file-input" id="csvFile" accept=".csv">
        <button id="processButton" class="btn btn-primary">Process Data</button>
    </div>

    <div class="loader" id="loader"></div>
    <div class="error-message" id="errorMessage"></div>

    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="yieldCurve">Yield Curve</button>
            <button class="tab-button" data-tab="pricingErrors">Pricing Errors</button>
            <button class="tab-button" data-tab="priceComparison">Price Comparison</button>
            <button class="tab-button" data-tab="yieldComparison">Yield Comparison</button>
            <button class="tab-button" data-tab="dataTable">Data Table</button>
        </div>

        <div class="tab-content active" id="yieldCurve">
            <div class="chart-container">
                <canvas id="yieldCurveChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="pricingErrors">
            <div class="chart-container">
                <canvas id="pricingErrorsChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="priceComparison">
            <div class="chart-container">
                <canvas id="priceComparisonChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="yieldComparison">
            <div class="chart-container">
                <canvas id="yieldComparisonChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="dataTable">
            <table class="table" id="bondDataTable">
                <thead>
                <tr>
                    <th>Start Date</th>
                    <th>Maturity Date</th>
                    <th>Coupon (%)</th>
                    <th>Price</th>
                    <th>Quoted Yield (%)</th>
                    <th>Model Yield (%)</th>
                    <th>Price Error</th>
                </tr>
                </thead>
                <tbody id="bondDataBody">
                <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<script>
    // Global variables for charts
    let yieldCurveChart, pricingErrorsChart, priceComparisonChart, yieldComparisonChart;
    let chartData = null;

    // Method specific to this page
    const METHOD = "svensson-new";

    // Initialize the page when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing application for " + METHOD);
        // Setup tab navigation
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // Initialize charts
        initializeCharts();

        // Setup process button click handler
        document.getElementById('processButton').addEventListener('click', processData);
        console.log("Event listeners setup complete");
    });

    // Show error message function
    function showError(message) {
        console.error("ERROR:", message);
        const errorElement = document.getElementById('errorMessage');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        document.getElementById('loader').style.display = 'none';
    }

    // Debug chart data function
    function debugChartData() {
        console.log("===== DEBUG CHART DATA =====");
        console.log("Chart data object:", chartData);

        if (!chartData) {
            console.error("Chart data is null or undefined");
            return;
        }

        console.log("Available methods in response:");
        if (chartData.curves) {
            const methods = Object.keys(chartData.curves);
            console.log(methods);

            // Debug current method
            console.log(`Current method (${METHOD}) data:`, chartData.curves[METHOD]);

            // Check if the current method exists in the response
            if (!chartData.curves[METHOD]) {
                console.error(`ERROR: Method '${METHOD}' not found in the response`);
                console.log("Available methods:", methods);
            } else {
                // Check if the method has all required data
                const methodData = chartData.curves[METHOD];
                console.log("Method data keys:", Object.keys(methodData));
                console.log("Dates array length:", methodData.dates ? methodData.dates.length : 0);
                console.log("Rates array length:", methodData.rates ? methodData.rates.length : 0);
                console.log("Bond prices array length:", methodData.bondPrices ? methodData.bondPrices.length : 0);
                console.log("Bond yields array length:", methodData.bondYields ? methodData.bondYields.length : 0);
                console.log("Pricing errors array length:", methodData.pricingErrors ? methodData.pricingErrors.length : 0);
            }
        } else {
            console.error("No 'curves' object in the response");
        }

        // Check other important data
        console.log("Maturities:", chartData.maturities ? chartData.maturities.length : 0);
        console.log("Quoted prices:", chartData.quotedPrices ? chartData.quotedPrices.length : 0);
        console.log("Quoted yields:", chartData.quotedYields ? chartData.quotedYields.length : 0);
    }

    function initializeCharts() {
        console.log("Initializing charts");
        try {
            // Yield Curve Chart
            const yieldCurveCtx = document.getElementById('yieldCurveChart').getContext('2d');
            yieldCurveChart = new Chart(yieldCurveCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Zero Rate (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(2) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Svensson (Filtered) Zero Rate Curve'
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Pricing Errors Chart
            const pricingErrorsCtx = document.getElementById('pricingErrorsChart').getContext('2d');
            pricingErrorsChart = new Chart(pricingErrorsCtx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Price Error'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Maturity'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Svensson (Filtered) Pricing Errors'
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Price Comparison Chart
            const priceComparisonCtx = document.getElementById('priceComparisonChart').getContext('2d');
            priceComparisonChart = new Chart(priceComparisonCtx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Maturity'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Svensson (Filtered) vs Quoted Prices'
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Yield Comparison Chart
            const yieldComparisonCtx = document.getElementById('yieldComparisonChart').getContext('2d');
            yieldComparisonChart = new Chart(yieldComparisonCtx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Yield (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(2) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Maturity'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Svensson (Filtered) vs Quoted Yields'
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
            console.log("Charts initialized successfully");
        } catch (error) {
            console.error("Error initializing charts:", error);
            showError("Failed to initialize charts: " + error.message);
        }
    }

    function processData() {
        console.log("Process data function called");
        const fileInput = document.getElementById('csvFile');
        if (fileInput.files.length === 0) {
            showError('Please select a CSV file first');
            return;
        }

        const file = fileInput.files[0];
        console.log("Selected file:", file.name, "Size:", file.size);

        // Check if it's a CSV file
        if (!file.name.toLowerCase().endsWith('.csv')) {
            showError('Please select a CSV file (must end with .csv)');
            return;
        }

        // Check file size (limit to 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showError('File is too large. Maximum size is 10MB.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Use method specific to this page
        formData.append('method', METHOD);
        console.log("Using method:", METHOD);

        // Show loader and hide error
        document.getElementById('loader').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        // Send the file to the backend
        console.log("Sending API request to /api/process");
        fetch('/api/process', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                console.log("API response received, status:", response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error("API error:", text);
                        throw new Error(`Server returned ${response.status}: ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loader
                document.getElementById('loader').style.display = 'none';

                console.log("API data received:", data);
                console.log("Has curves object:", data && typeof data.curves !== 'undefined');
                console.log("Has method data:", data && data.curves && typeof data.curves[METHOD] !== 'undefined');

                // Store data globally
                chartData = data;

                // Debug chart data
                debugChartData();

                // Update charts and tables
                updateCharts();
                updateDataTable();
            })
            .catch(error => {
                console.error("API request failed:", error);
                document.getElementById('loader').style.display = 'none';
                showError('Error: ' + error.message);
            });
    }

    function updateCharts() {
        console.log("Updating all charts");
        try {
            updateYieldCurveChart();
            updatePricingErrorsChart();
            updatePriceComparisonChart();
            updateYieldComparisonChart();
            console.log("All charts updated successfully");
        } catch (error) {
            console.error("Error updating charts:", error);
            showError('Error updating charts: ' + error.message);
        }
    }

    function updateYieldCurveChart() {
        console.log("Updating yield curve chart");
        // Clear existing data
        yieldCurveChart.data.labels = [];
        yieldCurveChart.data.datasets = [];

        if (!chartData) {
            console.error("No chart data available");
            return;
        }

        // If the curves object is missing, create a simple test curve
        if (!chartData.curves || !chartData.curves[METHOD]) {
            console.warn(`No curves data found for ${METHOD}, checking available methods`);
            if (chartData.curves) {
                console.warn("Available methods:", Object.keys(chartData.curves));
            }
            showError(`No data available for ${METHOD} method. Please try again or select a different method.`);
            return;
        }

        const curveData = chartData.curves[METHOD];
        console.log("Curve data for method:", curveData);

        // Use dates from the curve
        if (curveData.dates && curveData.dates.length > 0) {
            console.log("Date labels:", curveData.dates);
            yieldCurveChart.data.labels = curveData.dates.map(date =>
                new Date(date).toLocaleDateString()
            );
        } else {
            console.error("No dates found in curve data");
            return;
        }

        // Add dataset for Svensson (Filtered)
        if (curveData.rates && curveData.rates.length > 0) {
            console.log("Rate data:", curveData.rates);
            yieldCurveChart.data.datasets.push({
                label: 'Svensson (Filtered)',
                data: curveData.rates.map(rate => rate * 100),
                borderColor: 'rgb(153, 102, 255)',
                fill: false
            });
        } else {
            console.error("No rates found in curve data");
            return;
        }

        console.log("Updating chart with data:", yieldCurveChart.data);
        yieldCurveChart.update();
    }

    function updatePricingErrorsChart() {
        console.log("Updating pricing errors chart");
        pricingErrorsChart.data.datasets = [];

        if (!chartData || !chartData.curves || !chartData.curves[METHOD]) {
            console.error("Missing required data for pricing errors chart");
            return;
        }

        const curveData = chartData.curves[METHOD];

        if (curveData.pricingErrors && chartData.maturities) {
            console.log("Pricing errors:", curveData.pricingErrors);
            console.log("Maturities:", chartData.maturities);

            const points = chartData.maturities.map((date, i) => ({
                x: new Date(date).getTime(),
                y: curveData.pricingErrors[i]
            }));

            pricingErrorsChart.data.datasets.push({
                label: 'Svensson (Filtered) Pricing Errors',
                data: points,
                backgroundColor: 'rgb(153, 102, 255)'
            });
        } else {
            console.error("Missing pricing errors or maturities data");
            return;
        }

        pricingErrorsChart.update();
    }

    function updatePriceComparisonChart() {
        console.log("Updating price comparison chart");
        priceComparisonChart.data.datasets = [];

        if (!chartData || !chartData.curves || !chartData.curves[METHOD]) {
            console.error("Missing required data for price comparison chart");
            return;
        }

        const curveData = chartData.curves[METHOD];
        const maturities = chartData.maturities || [];
        const quotedPrices = chartData.quotedPrices || [];
        const modelPrices = curveData.bondPrices || [];

        console.log("Maturities:", maturities);
        console.log("Quoted prices:", quotedPrices);
        console.log("Model prices:", modelPrices);

        if (maturities.length === 0 || quotedPrices.length === 0 || modelPrices.length === 0) {
            console.error("Missing data for price comparison chart");
            return;
        }

        // Quoted prices dataset
        const quotedPoints = maturities.map((date, i) => ({
            x: new Date(date).getTime(),
            y: quotedPrices[i]
        }));

        priceComparisonChart.data.datasets.push({
            label: 'Quoted Prices',
            data: quotedPoints,
            backgroundColor: 'rgb(255, 99, 132)',
            pointStyle: 'circle'
        });

        // Model prices dataset
        const modelPoints = maturities.map((date, i) => ({
            x: new Date(date).getTime(),
            y: modelPrices[i]
        }));

        priceComparisonChart.data.datasets.push({
            label: 'Svensson (Filtered) Model Prices',
            data: modelPoints,
            backgroundColor: 'rgb(153, 102, 255)',
            pointStyle: 'cross'
        });

        priceComparisonChart.update();
    }

    function updateYieldComparisonChart() {
        console.log("Updating yield comparison chart");
        yieldComparisonChart.data.datasets = [];

        if (!chartData || !chartData.curves || !chartData.curves[METHOD]) {
            console.error("Missing required data for yield comparison chart");
            return;
        }

        const curveData = chartData.curves[METHOD];
        const maturities = chartData.maturities || [];
        const quotedYields = chartData.quotedYields || [];
        const modelYields = curveData.bondYields || [];

        console.log("Maturities:", maturities);
        console.log("Quoted yields:", quotedYields);
        console.log("Model yields:", modelYields);

        if (maturities.length === 0 || quotedYields.length === 0 || modelYields.length === 0) {
            console.error("Missing data for yield comparison chart");
            return;
        }

        // Quoted yields dataset
        const quotedPoints = maturities.map((date, i) => ({
            x: new Date(date).getTime(),
            y: quotedYields[i] * 100
        }));

        yieldComparisonChart.data.datasets.push({
            label: 'Quoted Yields',
            data: quotedPoints,
            backgroundColor: 'rgb(255, 99, 132)',
            pointStyle: 'circle'
        });

        // Model yields dataset
        const modelPoints = maturities.map((date, i) => ({
            x: new Date(date).getTime(),
            y: modelYields[i] * 100
        }));

        yieldComparisonChart.data.datasets.push({
            label: 'Svensson (Filtered) Model Yields',
            data: modelPoints,
            backgroundColor: 'rgb(153, 102, 255)',
            pointStyle: 'cross'
        });

        yieldComparisonChart.update();
    }

    function updateDataTable() {
        console.log("Updating data table");
        const tableBody = document.getElementById('bondDataBody');
        tableBody.innerHTML = '';

        if (!chartData || !chartData.curves || !chartData.curves[METHOD]) {
            console.error("Missing required data for data table");
            return;
        }

        const curveData = chartData.curves[METHOD];
        const startDates = chartData.startDates || [];
        const maturities = chartData.maturities || [];
        const coupons = chartData.coupons || [];
        const quotedPrices = chartData.quotedPrices || [];
        const quotedYields = chartData.quotedYields || [];
        const modelYields = curveData.bondYields || [];
        const modelPrices = curveData.bondPrices || [];

        console.log("Table data rows:", maturities.length);

        if (maturities.length === 0) {
            console.error("No maturity data available for table");
            return;
        }

        for (let i = 0; i < maturities.length; i++) {
            const row = document.createElement('tr');

            // Format data safely
            const startDate = startDates[i] ? new Date(startDates[i]).toLocaleDateString() : '';
            const maturityDate = maturities[i] ? new Date(maturities[i]).toLocaleDateString() : '';
            const coupon = coupons[i] !== undefined ? coupons[i].toFixed(2) : '';
            const quotedPrice = quotedPrices[i] !== undefined ? quotedPrices[i].toFixed(2) : '';
            const quotedYield = quotedYields[i] !== undefined ? (quotedYields[i] * 100).toFixed(2) : '';
            const modelYield = modelYields[i] !== undefined ? (modelYields[i] * 100).toFixed(2) : '';
            const priceError = (modelPrices[i] !== undefined && quotedPrices[i] !== undefined)
                ? (modelPrices[i] - quotedPrices[i]).toFixed(4) : '';

            row.innerHTML = `
                <td>${startDate}</td>
                <td>${maturityDate}</td>
                <td>${coupon}</td>
                <td>${quotedPrice}</td>
                <td>${quotedYield}</td>
                <td>${modelYield}</td>
                <td>${priceError}</td>
            `;

            tableBody.appendChild(row);
        }
        console.log("Data table updated successfully");
    }
</script>
</body>
</html>